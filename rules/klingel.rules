var DateTime lastRing

rule "Startup"
when
    System started
then
    logInfo("Klingel","Setzte lastRing auf " + now)
			
	lastRing = now
end

rule "Klingel stumm"
when
  //jeden Abend um 20.00 Uhr
  Time cron "0 00 20 * * ?"
then
  sendCommand(KlingelStumm, ON)
  logInfo("Klingel", "Klingel stumm geschaltet")
end

rule "Klingel nicht stumm"
when
  //jeden Morgen um 07.00 Uhr
  Time cron "0 00 07 * * ?"
then
  sendCommand(KlingelStumm, OFF)
  logInfo("Klingel", "Klingel nicht mehr stumm geschaltet")
end

rule "Klingel nicht stumm"
when
  //jeden Morgen um 07.10 Uhr
  Time cron "0 10 07 * * ?"
then
  sendCommand(KlingelStumm, OFF)
  logInfo("Klingel", "Klingel nicht mehr stumm geschaltet")
end


rule "Klingel"
	when
		Item Klingel changed to ON
	then
			if(lastRing.isBefore(now.minusSeconds(10))) {
				lastRing = now
				sendCommand(FlurBlinken, ON)
				if (KlingelStumm.state == OFF) {
					sendCommand(mihome_gateway_7c49ebb1dc1b_volume, 50)
					sendCommand(mihome_gateway_7c49ebb1dc1b_sound, 10)
				}
				sendTelegramPhoto("bot2", "http://192.168.178.31/snapshot.cgi?user=openhab&pwd=openhab", "Es klingelt")		
				//sendTelegram("bot1", "Es Klingelt")
				if (KlingelStumm.state == OFF) {
					createTimer(now.plusSeconds(5),  [ |
						sendCommand(mihome_gateway_7c49ebb1dc1b_sound, 10000)
						sendCommand(mihome_gateway_7c49ebb1dc1b_volume, 0)
        	])
				}
				sendCommand(Klingel, OFF)
			}
    end

rule "FlurBlinken"
	when
		Item FlurBlinken changed to ON
	then
		sendCommand(LichterFlur, ON)
		sendCommand(mihome_gateway_7c49ebb1dc1b_brightness, ON)
		createTimer(now.plusSeconds(2),  [ |
				sendCommand(LichterFlur, OFF)
				sendCommand(mihome_gateway_7c49ebb1dc1b_brightness, OFF)
    ])
		createTimer(now.plusSeconds(2),  [ |
				sendCommand(LichterFlur, ON)
				sendCommand(mihome_gateway_7c49ebb1dc1b_brightness, ON)
    ])
		createTimer(now.plusSeconds(2),  [ |
				sendCommand(LichterFlur, OFF)
				sendCommand(mihome_gateway_7c49ebb1dc1b_brightness, OFF)
    ])
		sendCommand(FlurBlinken, OFF)
	end
